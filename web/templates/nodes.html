{% extends "base.html" %}

{% block title %}Nœuds - DispyCluster{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- En-tête -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white">Nœuds du Cluster</h1>
            <p class="text-blue-100 mt-2">Surveillance et gestion des nœuds Raspberry Pi</p>
        </div>
    </div>
    
    <!-- Vue d'ensemble -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="metric-card card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Nœuds en ligne</p>
                    <p class="text-3xl font-bold text-gray-900" id="nodes-online">-</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-server text-green-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="metric-card card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">CPU moyen</p>
                    <p class="text-3xl font-bold text-gray-900" id="avg-cpu">-</p>
                </div>
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-microchip text-yellow-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="metric-card card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Mémoire moyenne</p>
                    <p class="text-3xl font-bold text-gray-900" id="avg-memory">-</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-memory text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="metric-card card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Température</p>
                    <p class="text-3xl font-bold text-gray-900" id="avg-temp">-</p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-thermometer-half text-red-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Graphiques de performance -->
    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">
        <div class="card p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Utilisation CPU</h3>
            <canvas id="cpu-chart" width="400" height="200"></canvas>
        </div>
        
        <div class="card p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Utilisation Mémoire</h3>
            <canvas id="memory-chart" width="400" height="200"></canvas>
        </div>

        <div class="card p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Température</h3>
            <canvas id="temp-chart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <!-- Liste des nœuds -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900">Nœuds</h2>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-500" id="nodes-count">0 nœuds</span>
            </div>
        </div>

        <div id="nodes-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            <div class="flex items-center justify-center py-12 col-span-full">
                <div class="loading"></div>
                <span class="ml-3 text-gray-600">Chargement des nœuds...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let nodes = [];
    let cpuChart = null;
    let memoryChart = null;
    let tempChart = null;
    let lastChartsUpdateTs = 0;
    
    function updateNodesList() {
        const container = document.getElementById('nodes-list');
        const countElement = document.getElementById('nodes-count');
        countElement.textContent = `${nodes.length} nœud${nodes.length > 1 ? 's' : ''}`;
        if (nodes.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 col-span-full">
                    <i class="fas fa-server text-gray-300 text-4xl mb-4"></i>
                    <p class="text-gray-500">Aucun nœud disponible</p>
                </div>
            `;
            return;
        }
        container.innerHTML = nodes.map(node => {
            const cpu = Number(node.cpu_usage || 0);
            const mem = Number(node.memory_usage || 0);
            const temp = Number(node.temperature || 0);
            const disk = Number(node.disk_usage || 0);
            const up = (node.status === 'ready' || node.is_healthy);
            return `
            <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 rounded-full ${up ? 'bg-green-500' : 'bg-red-500'}"></div>
                        <h3 class="text-lg font-semibold text-gray-900">${node.node}</h3>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${up ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${up ? 'En ligne' : 'Hors ligne'}</span>
                    </div>
                    <div class="text-sm text-gray-500">MAJ: ${new Date().toLocaleTimeString()}</div>
                </div>

                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-sm text-gray-600"><span>CPU</span><span>${cpu.toFixed(1)}%</span></div>
                        <div class="w-full h-2 bg-gray-100 rounded"><div class="h-2 rounded ${cpu<60?'bg-yellow-400':cpu<85?'bg-orange-500':'bg-red-600'}" style="width:${Math.min(cpu,100)}%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm text-gray-600"><span>Mémoire</span><span>${mem.toFixed(1)}%</span></div>
                        <div class="w-full h-2 bg-gray-100 rounded"><div class="h-2 rounded ${mem<60?'bg-purple-500':mem<85?'bg-purple-600':'bg-purple-800'}" style="width:${Math.min(mem,100)}%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm text-gray-600"><span>Disque</span><span>${disk.toFixed(1)}%</span></div>
                        <div class="w-full h-2 bg-gray-100 rounded"><div class="h-2 rounded ${disk<70?'bg-blue-500':disk<90?'bg-blue-600':'bg-blue-800'}" style="width:${Math.min(disk,100)}%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm text-gray-600"><span>Température</span><span>${temp.toFixed(1)}°C</span></div>
                        <div class="w-full h-2 bg-gray-100 rounded"><div class="h-2 rounded ${temp<55?'bg-green-500':temp<70?'bg-yellow-500':'bg-red-600'}" style="width:${Math.min(temp,100)}%"></div></div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }
    
    function updateOverviewMetrics() {
        const online = nodes.filter(n => (n.status === 'ready' || n.is_healthy));
        const avg = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0) / arr.length) : 0;
        const avgCpu = avg(online.map(n => n.cpu_usage || 0));
        const avgMem = avg(online.map(n => n.memory_usage || 0));
        const avgTemp = avg(online.map(n => n.temperature || 0));
        document.getElementById('nodes-online').textContent = online.length.toString();
        const totalEl = document.getElementById('nodes-count');
        if (totalEl) totalEl.textContent = `${nodes.length} nœud${nodes.length>1?'s':''}`;
        document.getElementById('avg-cpu').textContent = avgCpu ? `${avgCpu.toFixed(1)}%` : '-';
        document.getElementById('avg-memory').textContent = avgMem ? `${avgMem.toFixed(1)}%` : '-';
        document.getElementById('avg-temp').textContent = avgTemp ? `${avgTemp.toFixed(1)}°C` : '-';
    }

    function updateCharts() {
        const now = Date.now();
        if (now - lastChartsUpdateTs < 1200) { return; }
        lastChartsUpdateTs = now;

        const onlineNodes = nodes.filter(n => (n.status === 'ready' || n.is_healthy));
        const labels = onlineNodes.map(n => n.node);
        const cpuData = onlineNodes.map(n => n.cpu_usage || 0);
        const memData = onlineNodes.map(n => n.memory_usage || 0);
        const tempData = onlineNodes.map(n => n.temperature || 0);

        const commonOptions = {
            responsive: true,
            animation: { duration: 0 },
            scales: { y: { beginAtZero: true, suggestedMax: 100 } },
            plugins: { legend: { display: false } }
        };

        // CPU chart
        if (!cpuChart) {
            const cpuCtx = document.getElementById('cpu-chart').getContext('2d');
            cpuChart = new Chart(cpuCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'CPU Usage (%)',
                        data: cpuData,
                        backgroundColor: 'rgba(251, 191, 36, 0.8)',
                        borderColor: 'rgba(251, 191, 36, 1)',
                        borderWidth: 1
                    }]
                },
                options: commonOptions
            });
        } else {
            cpuChart.data.labels = labels;
            cpuChart.data.datasets[0].data = cpuData;
            cpuChart.update('none');
        }

        // Memory chart
        if (!memoryChart) {
            const memCtx = document.getElementById('memory-chart').getContext('2d');
            memoryChart = new Chart(memCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Memory Usage (%)',
                        data: memData,
                        backgroundColor: 'rgba(147, 51, 234, 0.8)',
                        borderColor: 'rgba(147, 51, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: commonOptions
            });
        } else {
            memoryChart.data.labels = labels;
            memoryChart.data.datasets[0].data = memData;
            memoryChart.update('none');
        }

        // Temperature chart
        if (!tempChart) {
            const tCtx = document.getElementById('temp-chart').getContext('2d');
            tempChart = new Chart(tCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Température (°C)',
                        data: tempData,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: { ...commonOptions, scales: { y: { beginAtZero: true } } }
            });
        } else {
            tempChart.data.labels = labels;
            tempChart.data.datasets[0].data = tempData;
            tempChart.update('none');
        }
    }

    // Brancher WebSocket sur /monitoring
    document.addEventListener('DOMContentLoaded', () => {
        const mon = io('/monitoring');
        mon.on('cluster_metrics', (data) => {
            const mapped = data && data.nodes ? Object.entries(data.nodes).map(([node, metrics]) => ({
                node,
                cpu_usage: metrics.cpu_usage || 0,
                memory_usage: metrics.memory_usage || 0,
                disk_usage: (metrics.disk_usage !== undefined) ? metrics.disk_usage : (metrics.disk_total ? (100 - (100 * (metrics.disk_available || 0) / metrics.disk_total)) : 0),
                temperature: metrics.temperature || 0,
                is_healthy: metrics.is_healthy,
                status: (metrics.cpu_usage || 0) > 0 ? 'ready' : 'unknown'
            })) : [];
            nodes = mapped;
            updateNodesList();
            updateOverviewMetrics();
            updateCharts();
        });
        mon.on('connect', () => {
            mon.emit('request_nodes_status', {});
        });
    });
</script>
{% endblock %}