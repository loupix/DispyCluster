{% extends "base.html" %}

{% block title %}Monitoring - DispyCluster{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- En-tête -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white">Surveillance du Cluster</h1>
            <p class="text-blue-100 mt-2">Métriques et graphiques de performance</p>
        </div>
    </div>
    
    <!-- Vue d'ensemble du cluster -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="metric-card card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Nœuds en ligne</p>
                    <p class="text-3xl font-bold text-gray-900" id="online-nodes">-</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-server text-green-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="metric-card card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">CPU moyen</p>
                    <p class="text-3xl font-bold text-gray-900" id="avg-cpu">-</p>
                </div>
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-microchip text-yellow-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="metric-card card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Mémoire moyenne</p>
                    <p class="text-3xl font-bold text-gray-900" id="avg-memory">-</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-memory text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="metric-card card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Température</p>
                    <p class="text-3xl font-bold text-gray-900" id="avg-temperature">-</p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-thermometer-half text-red-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Graphiques historiques -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Utilisation CPU</h3>
                <div class="flex items-center space-x-2">
                    <select id="cpu-time-range" onchange="updateCpuChart()" class="border border-gray-300 rounded-lg px-2 py-1 text-sm">
                        <option value="1">1h</option>
                        <option value="6">6h</option>
                        <option value="24" selected>24h</option>
                        <option value="168">7j</option>
                    </select>
                </div>
            </div>
            <div style="height: 300px;">
                <div id="cpu-chart-loading" class="flex items-center justify-center h-full">
                    <div class="loading"></div>
                    <span class="ml-3 text-gray-600">Chargement du graphique CPU...</span>
                </div>
                <canvas id="cpu-chart" style="display: none;"></canvas>
            </div>
        </div>
        
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Utilisation Mémoire</h3>
                <div class="flex items-center space-x-2">
                    <select id="memory-time-range" onchange="updateMemoryChart()" class="border border-gray-300 rounded-lg px-2 py-1 text-sm">
                        <option value="1">1h</option>
                        <option value="6">6h</option>
                        <option value="24" selected>24h</option>
                        <option value="168">7j</option>
                    </select>
                </div>
            </div>
            <div style="height: 300px;">
                <div id="memory-chart-loading" class="flex items-center justify-center h-full">
                    <div class="loading"></div>
                    <span class="ml-3 text-gray-600">Chargement du graphique Mémoire...</span>
                </div>
                <canvas id="memory-chart" style="display: none;"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Graphiques supplémentaires -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Utilisation Disque</h3>
                <div class="flex items-center space-x-2">
                    <select id="disk-time-range" onchange="updateDiskChart()" class="border border-gray-300 rounded-lg px-2 py-1 text-sm">
                        <option value="1">1h</option>
                        <option value="6">6h</option>
                        <option value="24" selected>24h</option>
                        <option value="168">7j</option>
                    </select>
                </div>
            </div>
            <div style="height: 300px;">
                <div id="disk-chart-loading" class="flex items-center justify-center h-full">
                    <div class="loading"></div>
                    <span class="ml-3 text-gray-600">Chargement du graphique Disque...</span>
                </div>
                <canvas id="disk-chart" style="display: none;"></canvas>
            </div>
        </div>
        
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Température</h3>
                <div class="flex items-center space-x-2">
                    <select id="temp-time-range" onchange="updateTempChart()" class="border border-gray-300 rounded-lg px-2 py-1 text-sm">
                        <option value="1">1h</option>
                        <option value="6">6h</option>
                        <option value="24" selected>24h</option>
                        <option value="168">7j</option>
                    </select>
                </div>
            </div>
            <div style="height: 300px;">
                <div id="temp-chart-loading" class="flex items-center justify-center h-full">
                    <div class="loading"></div>
                    <span class="ml-3 text-gray-600">Chargement du graphique Température...</span>
                </div>
                <canvas id="temp-chart" style="display: none;"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Liste des nœuds -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900">Nœuds du Cluster</h2>
            <span id="nodes-count" class="text-sm text-gray-600">- nœuds</span>
        </div>
        
        <div id="nodes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <div class="flex items-center justify-center py-8 col-span-full">
                <div class="loading"></div>
                <span class="ml-3 text-gray-600">Chargement...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let nodes = [];
    let lastUpdateTs = 0;
    let cpuChart = null;
    let memoryChart = null;
    let diskChart = null;
    let tempChart = null;

    function computeAndRenderOverview() {
        const online = nodes.filter(n => (n.status === 'ready' || n.is_healthy));
        const avg = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0) / arr.length) : 0;
        const avgCpu = avg(online.map(n => n.cpu_usage || 0));
        const avgMem = avg(online.map(n => n.memory_usage || 0));
        const temps = online.filter(n => typeof n.temperature === 'number');
        const avgTemp = avg(temps.map(n => n.temperature || 0));
        document.getElementById('online-nodes').textContent = online.length.toString();
        document.getElementById('avg-cpu').textContent = avgCpu ? `${avgCpu.toFixed(1)}%` : '-';
        document.getElementById('avg-memory').textContent = avgMem ? `${avgMem.toFixed(1)}%` : '-';
        document.getElementById('avg-temperature').textContent = avgTemp ? `${avgTemp.toFixed(1)}°C` : '-';
        document.getElementById('nodes-count').textContent = `${nodes.length} nœuds`;
    }

    function renderNodesGrid() {
        const container = document.getElementById('nodes-list');
        if (nodes.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 col-span-full">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-3xl mb-2"></i>
                    <p class="text-gray-600">Aucun nœud trouvé</p>
                </div>`;
            return;
        }
        container.innerHTML = nodes.map(node => {
            const up = (node.status === 'ready' || node.is_healthy);
            const cpu = Number(node.cpu_usage || 0);
            const mem = Number(node.memory_usage || 0);
            const disk = Number(node.disk_usage || 0);
            const temp = Number(node.temperature || 0);
            return `
            <div class="bg-gray-50 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full ${up?'bg-green-500':'bg-red-500'}"></div>
                        <span class="font-medium text-gray-900">${node.node}</span>
                    </div>
                    <span class="px-2 py-1 text-xs rounded-full ${up?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${up?'En ligne':'Hors ligne'}</span>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between"><span class="text-sm text-gray-600">CPU</span><span class="text-sm font-semibold">${cpu.toFixed(1)}%</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full ${cpu<60?'bg-yellow-400':cpu<85?'bg-orange-500':'bg-red-600'}" style="width:${Math.min(cpu,100)}%"></div></div>
                    <div class="flex items-center justify-between"><span class="text-sm text-gray-600">RAM</span><span class="text-sm font-semibold">${mem.toFixed(1)}%</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full bg-purple-600" style="width:${Math.min(mem,100)}%"></div></div>
                    <div class="flex items-center justify-between"><span class="text-sm text-gray-600">Disque</span><span class="text-sm font-semibold">${disk.toFixed(1)}%</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full bg-blue-600" style="width:${Math.min(disk,100)}%"></div></div>
                    <div class="flex items-center justify-between"><span class="text-sm text-gray-600">Temp</span><span class="text-sm font-semibold">${temp?temp.toFixed(1):'-'}°C</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full ${temp<55?'bg-green-500':temp<70?'bg-yellow-500':'bg-red-600'}" style="width:${Math.min(temp,100)}%"></div></div>
                </div>
            </div>`;
        }).join('');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const mon = io('/monitoring');
        mon.on('cluster_metrics', (data) => {
            const mapped = data && data.nodes ? Object.entries(data.nodes).map(([node, m]) => ({
                node,
                cpu_usage: m.cpu_usage || 0,
                memory_usage: m.memory_usage || 0,
                temperature: m.temperature || 0,
                disk_usage: (m.disk_usage !== undefined) ? m.disk_usage : (m.disk_total ? (100 - (100 * (m.disk_available || 0) / m.disk_total)) : 0),
                is_healthy: m.is_healthy,
                status: (m.cpu_usage || 0) > 0 ? 'ready' : 'unknown'
            })) : [];
            nodes = mapped;
            const now = Date.now();
            if (now - lastUpdateTs < 800) return;
            lastUpdateTs = now;
            computeAndRenderOverview();
            renderNodesGrid();
        });
        mon.on('connect', () => {
            mon.emit('request_nodes_status', {});
            mon.emit('request_cluster_status', {});
        });
        // Charger les graphes historiques au démarrage puis à intervalle régulier sans flicker
        loadChartsStable();
        setInterval(loadChartsStable, 30000);
    });

    async function loadChartsStable() {
        // CPU
        try {
            const hCpu = document.getElementById('cpu-time-range').value || 24;
            const r1 = await axios.get(`/api/graphs/cpu-history?hours=${hCpu}`);
            const data1 = r1.data.data || [];
            const labels1 = data1.map(p => new Date(p.timestamp).toLocaleTimeString('fr-FR'));
            const series1 = data1.map(p => p.avg_cpu ?? p.cpu_usage ?? 0);
            const optionsCommon = { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } };
            if (!cpuChart) {
                document.getElementById('cpu-chart-loading').style.display = 'none';
                document.getElementById('cpu-chart').style.display = 'block';
                cpuChart = new Chart(document.getElementById('cpu-chart').getContext('2d'), {
                    type: 'line', data: { labels: labels1, datasets: [{ data: series1, borderColor: 'rgba(251,191,36,1)', backgroundColor: 'rgba(251,191,36,0.2)', tension: 0.35, fill: true }] }, options: optionsCommon
                });
            } else {
                cpuChart.data.labels = labels1;
                cpuChart.data.datasets[0].data = series1;
                cpuChart.update('none');
            }
        } catch {}

        // Memory
        try {
            const hMem = document.getElementById('memory-time-range').value || 24;
            const r2 = await axios.get(`/api/graphs/memory-history?hours=${hMem}`);
            const data2 = r2.data.data || [];
            const labels2 = data2.map(p => new Date(p.timestamp).toLocaleTimeString('fr-FR'));
            const series2 = data2.map(p => p.avg_memory ?? p.memory_usage ?? 0);
            const optionsCommon = { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } };
            if (!memoryChart) {
                document.getElementById('memory-chart-loading').style.display = 'none';
                document.getElementById('memory-chart').style.display = 'block';
                memoryChart = new Chart(document.getElementById('memory-chart').getContext('2d'), {
                    type: 'line', data: { labels: labels2, datasets: [{ data: series2, borderColor: 'rgba(147,51,234,1)', backgroundColor: 'rgba(147,51,234,0.2)', tension: 0.35, fill: true }] }, options: optionsCommon
                });
            } else {
                memoryChart.data.labels = labels2;
                memoryChart.data.datasets[0].data = series2;
                memoryChart.update('none');
            }
        } catch {}

        // Disk
        try {
            const hDisk = document.getElementById('disk-time-range').value || 24;
            const r3 = await axios.get(`/api/graphs/disk-history?hours=${hDisk}`);
            const data3 = r3.data.data || [];
            const labels3 = data3.map(p => new Date(p.timestamp).toLocaleTimeString('fr-FR'));
            const series3 = data3.map(p => p.avg_disk ?? p.disk_usage ?? 0);
            const optionsCommon = { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } };
            if (!diskChart) {
                document.getElementById('disk-chart-loading').style.display = 'none';
                document.getElementById('disk-chart').style.display = 'block';
                diskChart = new Chart(document.getElementById('disk-chart').getContext('2d'), {
                    type: 'line', data: { labels: labels3, datasets: [{ data: series3, borderColor: 'rgba(16,185,129,1)', backgroundColor: 'rgba(16,185,129,0.2)', tension: 0.35, fill: true }] }, options: optionsCommon
                });
            } else {
                diskChart.data.labels = labels3;
                diskChart.data.datasets[0].data = series3;
                diskChart.update('none');
            }
        } catch {}

        // Temperature
        try {
            const hTemp = document.getElementById('temp-time-range').value || 24;
            const r4 = await axios.get(`/api/graphs/temperature-history?hours=${hTemp}`);
            const data4 = r4.data.data || [];
            const labels4 = data4.map(p => new Date(p.timestamp).toLocaleTimeString('fr-FR'));
            const series4 = data4.map(p => p.avg_temperature ?? p.temperature ?? 0);
            const optionsCommon = { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } };
            if (!tempChart) {
                document.getElementById('temp-chart-loading').style.display = 'none';
                document.getElementById('temp-chart').style.display = 'block';
                tempChart = new Chart(document.getElementById('temp-chart').getContext('2d'), {
                    type: 'line', data: { labels: labels4, datasets: [{ data: series4, borderColor: 'rgba(239,68,68,1)', backgroundColor: 'rgba(239,68,68,0.2)', tension: 0.35, fill: true }] }, options: optionsCommon
                });
            } else {
                tempChart.data.labels = labels4;
                tempChart.data.datasets[0].data = series4;
                tempChart.update('none');
            }
        } catch {}
    }
</script>
{% endblock %}